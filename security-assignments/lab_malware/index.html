<!DOCTYPE html>
<html lang="en" xml:lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link type="text/plain" rel="author" href="/humans.txt" />
  <link rel="shortcut icon" href="/favicon.ico?v=92502d237dc856d080ccef6ea6f23eeb27ec96ab">

  <link href="/assets/css/bootstrap-custom.css?v=92502d237dc856d080ccef6ea6f23eeb27ec96ab" rel="stylesheet" media="screen">
  <link href="/assets/css/style.css?v=92502d237dc856d080ccef6ea6f23eeb27ec96ab" rel="stylesheet" media="screen">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <script src="/assets/vendor/jquery/dist/jquery.min.js"></script>

  
      <link type="application/atom+xml" rel="alternate" href="https://daveeargle.com/feed.xml" title="Dave Eargle" />
<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Lab – Malware Analysis | Dave Eargle</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Lab – Malware Analysis" />
<meta name="author" content="deargle" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introductory Malware dissection" />
<meta property="og:description" content="Introductory Malware dissection" />
<link rel="canonical" href="https://daveeargle.com/security-assignments/lab_malware/" />
<meta property="og:url" content="https://daveeargle.com/security-assignments/lab_malware/" />
<meta property="og:site_name" content="Dave Eargle" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@deargle" />
<script type="application/ld+json">
{"@type":"WebPage","headline":"Lab – Malware Analysis","url":"https://daveeargle.com/security-assignments/lab_malware/","author":{"@type":"Person","name":"deargle"},"description":"Introductory Malware dissection","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
      
  

</head>
<body class="tony-assignment post-security-assignments-lab_malware" id="/security-assignments/lab_malware">

<div class="container">

  
  
  

  
  <div class="content" id="content" role="main">


<h1 class='title'>Lab &ndash; Malware Analysis</h1> 



<p>See <a href='/security-assignments/virtual-machines/#setting-up-virtualbox-and-the-infoset-net-network'>here</a> for instructions on setting up virtualbox for this class.</p>

<div class='alert alert-info'><strong>Heads up!</strong> Be sure that you have created the <code>infosec-net</code> virtualbox network, as specified at the top of the above link, <i>before</i> importing the vm! It's not the end of the world if you don't, but it does require some extra work.</div>

<p>This lab uses the following <a href='/security-assignments/virtual-machines/#the-virtual-machines'>vms:</a></p>
<ul>

    <li>Windows 10</li>

</ul>



<h1 id="overview">Overview</h1>

<p>In this lab, you will prod at and run live malware called WannaCry. You will be fine as long as you follow instructions. Please talk to me if you are scared.</p>

<div class="alert alert-info"><strong>Rhetorical question.</strong> Have you backed up your data lately?</div>

<p>Take a gander at the reading assigned for the malware topic, listed on canvas. It is library access to the first introductory chapter of <a href="https://nostarch.com/malware">“Practical Malware Analysis – The Hands-On Guide to Dissecting Malicious Software”</a>
by Michael Sikorski and Andrew Honig. The book is accessible for beginners such as yourself, and is also a handy reference for more advanced analysts.</p>

<h1 id="analyze-the-malware">Analyze the Malware</h1>

<p>In this lab, you’ll WannaCry. This program made international headlines last summer when it <a href="https://www.nytimes.com/2017/05/12/world/europe/uk-national-health-service-cyberattack.html">wreaked havoc across the world</a> 
before being disabled by malware analyst Marcus Hutchins.</p>

<p>WannaCry is ransomware that encrypts the victim’s files and demands ransom in order to decrypt. But due to a programming error, WannaCry does not decrypt victim’s files even after the ransom is paid.</p>

<h2 id="confirm-vm-settings-for-great-safety-and-much-assurance">Confirm VM settings for great safety and much assurance</h2>

<p>It is possible for WannaCry to “escape” the VM and spread to a wider network if two conditions are met:</p>
<ol>
  <li>The virtual machine has a network adapter that gives it access to other machines on a network, and</li>
  <li>The other machines on that network are not patched against WannaCry’s spreading mechanism.</li>
</ol>

<p>For #2 – This version of WannaCry uses the <a href="https://en.wikipedia.org/wiki/EternalBlue">EternalBlue</a> exploit to spread. Eternal Blue was developed by the NSA, and stolen and leaked by Shadow Brokers, and
subsequently picked up by North Korean agents and used in WannaCry. Microsoft issued a patch for EternalBlue in March 2017. If you are running Windows and have installed updates since then, you’ll be fine.</p>

<p>For #1 – WannaCry will not spread to your host unless you changed the defaults on the Windows VM I distributed and set up a host-only network adapter. If you did, you should panic, and undo that.
In theory, I think that WannaCry could reach out over the NAT adapter and attempt to exploit servers on the public internet – but mercy on any public server that is still vulnerable to
WannaCry. They would have been infected many times over by now.</p>

<div class="alert alert-danger"><strong>Heads up!</strong> Make sure that you have taken a snapshot of your Windows VM before proceeding. Having one will let you undo the messed-up state after you run the malware.</div>

<h2 id="preliminary-analysis">Preliminary Analysis</h2>

<p>The WannaCry executable is zipped up in an encrypted folder on your desktop called “LIVE MALWARE WannaCry.exe”. However, <span class="label label-danger">ignore this folder,</span> 
this zip contains only the “loader” or “encrypter” component. The “worm” component – the part that spreads wannacry around to other hosts – is a separate executable that I forgot to 
include on the VM. So, let’s grab it.</p>

<ol>
  <li>
    <p>Make sure that Windows Defender is disabled.</p>
  </li>
  <li>
    <p>Download the worm + loader executable from <a href="https://www.malware-traffic-analysis.net/2017/05/18/index2.html">here</a> (look for the <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe.zip</code> link).</p>
  </li>
  <li>
    <p>Extract the malware by right-clicking the folder, choosing <code class="highlighter-rouge">Extract all...</code>,
and entering the password <code class="highlighter-rouge">infected</code>. This will create a new folder called “24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe.zip”, inside of which is a <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code> file.
<span class="label lable-danger">Do not run this file yet!</span></p>

    <p><span class="label label-info">This is the dropper and spreader only.</span> Technically, it performs no encryption. It has stashed inside of it the wannacry encryptor. Its job is to drop the encryptor on a host, run it, and then scan the network
and infect as many other machines as it can.</p>
  </li>
  <li>Open a <code class="highlighter-rouge">cmd</code> terminal via the Windows searchbar. Therein, do the following:
    <ul>
      <li>Use <code class="highlighter-rouge">cd</code> to navigate into the extracted folder containing <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code></li>
      <li>Hash the exe using the <code class="highlighter-rouge">md5deep</code> and <code class="highlighter-rouge">sha256deep</code> utilities.</li>
    </ul>
  </li>
  <li>Google the hashes to see what comes up.</li>
  <li>
    <p>Go to <a href="http://VirusTotal.com">VirusTotal.com</a> and either search for the hash, or upload the <code class="highlighter-rouge">.exe</code> file. If you do the latter, click the “View last analysis” button. Both approaches should return the same results.</p>

    <p>VirusTotal.com can run files and URLs through a barrage of antivirus programs to detect malicious files. 
This can be much more effective than checking a file against only one or two detection programs. 
However, people who create viruses also use this site to see whether their malicious code flags, 
and tweak the code until it comes up clean. It is not uncommon for a piece of malware to only turn up a few hits in VirusTotal.</p>

    <div class="alert alert-warning"><strong>Question: </strong>What does Ad-Aware report this hash to be?</div>
  </li>
  <li>
    <p>Browse to the website <a href="http://Reverse.it">Reverse.it</a> (now owned by hybrid-analysis), and click on “Select file,” and upload the WannaCry worm file (the .exe) or search for its hash. Reverse.it will check the hash of the file against previously analyzed files. 
Select any of the Note the wide range of information that this site provides about the executable. Examine the IP address
that this malware attempt to access – see the “Network Analysis” section (accessible via the menu on the right-hand side), and then the “Contacted Hosts” section. Keep this IP address in the back of 
your mind somewhere.</p>

    <div class="alert alert-warning"><strong>Question: </strong>What IP address does the spreader attempt to access?</div>
  </li>
</ol>

<p>Now we will manually perform some of the analyses that reverse.it performs, in order to get a hands-on feel for the work involved.</p>

<div class="alert alert-info"><strong>You may ask, "Why are you asking us to do this? Are we not weakling business school students?"</strong> In fact, yes, you <em>are</em> weakling business
school students. 

<p>As we have discussed in class a few times now,
I do not expect you to become experts in any of the domains the labs have you explore. One of the learning objectives of this class is to help you appreciate the
broad set of skills required for information security analysis, and in turn, information security management. Despite how it may appear to you, we are not going very deep
into any of the lab topic areas. We are only scratching the surface(s). But if you can understand these basics, you will be better able to represent, advocate for, 
and manage the information security function in your organizations.</p>

<p>Specifically for this lab, if an organization gets hit by malware, upper management all the way to the top will want to know exactly what happened. Basic malware analysis can provide answers
for upper management. If you are in a management position, you may want to know answers to questions that approaches in this lab can help answer.</p>
</div>

<h2 id="static-analysis">Static Analysis</h2>

<p>Static Analysis is usually the first step in malware analysis. It involves gathering as much information as possible from a potential malware file and determining its 
functionality, purpose, and identifying traits to the greatest degree possible. Static analysis does not involve running the malware file, and thus is less risky 
than dynamic analysis. However, caution must be used here (and in all stages of analysis), as certain analysis tools may execute the malware without warning.</p>

<h3 id="using-the-strings-program">Using the Strings Program</h3>

<p>As its name implies, <code class="highlighter-rouge">strings</code> is a command-line tool that will parse through a file and pull out any character strings in either ASCII or Unicode. 
The result of running this tool can tell you many things about potential malware:</p>

<ul>
  <li>Error messages can give telling information about the functionality of a program.</li>
  <li>IP addresses that the program will call to.</li>
  <li>Windows built-in library function files (DLLs) that the program will try to access.</li>
</ul>

<p>In this lab, we will use several tools from a set of tools developed in 1996 which still rocks called <a href="https://docs.microsoft.com/en-us/sysinternals/">sysinternals</a>.</p>

<ul>
  <li>Download <code class="highlighter-rouge">strings</code> from <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/strings">here</a> and extract the downloaded zip file.</li>
  <li>Copy-paste <code class="highlighter-rouge">strings.exe</code> into the <code class="highlighter-rouge">C:\bin</code> directory.</li>
  <li>
    <p>For convenience, add the <code class="highlighter-rouge">C:\bin</code> directory to your cmd <code class="highlighter-rouge">path</code> which will let you run the commands in that directory without having to reference the entire path to their location. Run the following 
from a Powershell terminal (windows searchbar &gt; “powershell”):</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Environment]::SetEnvironmentVariable("Path", $env:Path + ";C:\bin", [EnvironmentVariableTarget]::User)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Now run the strings program to see a list of options and commands. From a <em>new</em> cmd prompt opened <em>after</em> adding <code class="highlighter-rouge">c:\bin</code> to the path, confirm that you can run <code class="highlighter-rouge">strings</code>:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strings
</code></pre></div>    </div>

    <p>Look at its options.</p>
  </li>
  <li>
    <p>From a <code class="highlighter-rouge">cmd</code> prompt in the directory where <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code> is located, run the following:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strings -n 12 24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe &gt; output.txt
notepad output.txt        
</code></pre></div>    </div>

    <p>The “-n” option means “minimum string length.”</p>

    <p>You may recognize this strings output from the Reverse.It report.</p>

    <div class="alert alert-info">
      <p><em>Use tab-completion to fill out that filename, for crying out loud. Do not copy-paste. If you keep copy-pasting, I will turn all code-snippets on my site into screenshots to spite you.</em></p>

      <p>Also, a convenient shortcut to opening a windows shell in a certain directory is to use Windows Explorer (the graphical file explorer thing) to navigate to where you want to go, then
right-click in the white area in that directory listing, and choose “Open PowerShell window here”. PowerShell can do everything a <code class="highlighter-rouge">cmd</code> prompt can do, and more.</p>
    </div>

    <p>Search through output.txt (ctrl+f) for a <code class="highlighter-rouge">http://</code> url. This url is the “killswitch” domain which, when registered, <a href="https://www.wired.com/2017/05/accidental-kill-switch-slowed-fridays-massive-ransomware-attack/">blocked the wannacry spreader from
doing its thing</a>. See <a href="https://blog.comae.io/wannacry-new-variants-detected-b8908fefea7e">the comic on this page</a> 
to understand in four simple comic panels the facepalm reason why that functionality is even in the spreader in the first place.</p>

    <div class="alert alert-warning"><strong>Question: </strong>What is the killswitch domain for this worm?</div>
  </li>
</ul>

<h3 id="resource-hacker">Resource Hacker</h3>

<p>Resource Hacker is another useful tool that can often pull information from a malware sample without executing the malware. Windows application development tools will set values in this section, 
but developers can override and set whatever information they want, if they so desire. Regardless, examining the values can sometimes give hints about and insight into the malware.</p>

<ol>
  <li>Download “Resource Hacker” from <a href="http://www.angusj.com/resourcehacker/#download">here</a>, and install it. Open “Resource Hacker” by searching for it from the windows search bar.</li>
  <li>Load the wannacry worm into resource hacker.</li>
  <li>
    <p>Navigate through the folder tree structure to see information about the malware.</p>

    <ol>
      <li>
        <p>Examine the “Version Info” node, and look at the “FileVersion”. This can be helpful to track to note versions of malware that may be floating around.</p>

        <div class="alert alert-warning"><strong>Question: </strong>What FileVersion does this malware claim to be?</div>

        <p>lol and look at the CompanyName, FileDescription, and LegalCopyright. Cheeky North Koreans.</p>

        <div class="alert alert-warning"><strong>Question: </strong>What is the name of the company that this malware claims is its author?</div>
      </li>
      <li>
        <p>Applications can embed applications within their <em>resource</em> section, which is accessible via
the navbar on the left under the <code class="highlighter-rouge">R</code> tree. The loader stores the wannacry encryptor here. When the loader runs, if the killswitch is not triggered, it
will extract the embedded resource payload, install it, and run it. Let’s extract it manually and play with it, eh?</p>

        <ol>
          <li>Expand the “R” node and right-click the star range. Choose <code class="highlighter-rouge">Save Resources to a BIN file</code> (a BIN file is another name for a <code class="highlighter-rouge">.exe</code> in windows). Save it
where you like. <em>This is the wannacry encryptor</em>. <span class="label label-danger">If you run this, say goodbye to your vm files.</span> Rename it to be <code class="highlighter-rouge">wannacry.exe</code> for your convenience, if you
feel like it.</li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<h3 id="strings-again-this-time-on-the-wannacry-encryptor">Strings again, this time on the wannacry encryptor</h3>

<ol>
  <li>
    <p>From a cmd prompt in the directory where your newly extracted wannacry.exe is located, run the following:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strings -n 12 wannacry.exe &gt; output.txt
notepad output.txt
</code></pre></div>    </div>

    <p>Read through the output.txt file and look for sensical strings. Some malware can use “packing” tricks to make it harder for malware analysts to perform static analysis (read more about it <a href="https://securingtomorrow.mcafee.com/business/malware-packers-use-tricks-avoid-analysis-detection/">here</a>). “Packing” is a form of compressing that is sometimes also combined with encryption. If this malware
were “packed”, <code class="highlighter-rouge">strings</code> would find no sensical text inside. If it is <em>not</em> packed, you will see English words which are names of windows functions or custom that the malware may call internally.</p>

    <div class="alert alert-warning"><strong>Question: </strong>Is this malware likely "packed", or is it "unpacked"?</div>

    <div class="alert alert-info"><strong>Consider.</strong> If you did not know what this malware did, what would seeing calls in the <code>strings</code> output to windows functions such as 
"CryptDecrypt", "CryptEncrypt", "CryptDestroyKey", and "CryptImportKey" tell you? Dadgum right, got ransomware on our dadgum hands.</div>
  </li>
</ol>

<h3 id="analyzing-dlls-with-dependency-walker">Analyzing DLLs with Dependency Walker</h3>

<p>A few Dynamic Linked Library (dll – the windows function library calls) appeared when we ran the Strings program above. We can use another program, Dependency Walker, to obtain more
information about those dlls and their use by the malware. Dynamic linking is an area that gives a great deal of insight into how a program functions, and it is of particular importance to malware analysis.</p>

<ol>
  <li>
    <p>Download Dependency Walker from <a href="http://www.dependencywalker.com/">http://www.dependencywalker.com/</a>. Extract the zip file contents, and run <code class="highlighter-rouge">depends.exe</code>. When the program loads, use the 
“open” button on the top-left and load wanncry.exe.</p>
  </li>
  <li>
    <p>There’s a lot of information here, so let’s step through it.</p>
    <ul>
      <li>The top-left pane shows all of the DLL files that are called by the WannaCry program.</li>
      <li>The top-right pane shows the functions that are called by the selected DLL.</li>
      <li>The right-middle pane shows all possible functions that could be called by the selected DLL, along with their ordinal values; 
a function can either be called by its name or by the ordinal value, so if you see an ordinal value called you can use this list 
to check its functionality. Calling functions by ordinal allows a program to call the function without ever using its name in the code. 
It can be a useful obfuscation technique.</li>
      <li>The bottom two panes show additional information.</li>
    </ul>

    <p>Spend some time looking through the different DLLs.</p>

    <div class="alert alert-warning"><strong>Question: </strong>Under ADVAPI32.DLL, find BCRYPT.DLL. What is function for ordinal value 37, i.e., the 37th function from the top?</div>

    <div class="alert alert-info">Bcrypt.dll is a family of functions, documented and listed [here](https://docs.microsoft.com/en-us/windows/desktop/api/bcrypt/). Bcrypt.dll is not the same as the blowcrypt family of algorithms
that we studied earlier in the semester. bcrypt.dll lamely refers to "bestcrypt", a.k.a "Cryptography: Next Generation (cng)" (see [here](https://stackoverflow.com/questions/9711568/does-winapis-bcrypt-h-actually-support-bcrypt-hashing)).
It is the built-in Windows way to perform encryption. And yes, that means that Wannacry is lamely using Windows functions, instead of making their own functions, to encrypt all the things. Lazy son of
a guns.</div>
  </li>
</ol>

<h2 id="dynamic-analysis-of-wannacry">Dynamic Analysis of WannaCry</h2>

<p>Now we come to the fun part. Dynamic Analysis is used to gather information about a file that could not be gathered during static analysis. 
Dynamic Analysis is inherently riskier than static analysis, as it involves investigating malware as it runs, or the state of the host machine 
after the malware has executed. The drawbacks of dynamic analysis are that (1) malware may behave differently in a VM environment if the malware detects
that it is in such a setting; (2) malware may behave differently depending on available network and Internet connections, and (3) running malware may potentially expose the host or other hosts on a network 
to risk, as mentioned previously. But don’t worry about #3, you’ll <em>probably</em> be fine!</p>

<p>Grab some more sysinternals tools:</p>

<ul>
  <li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Process Monitor</a></li>
  <li><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer">Process Explorer</a></li>
</ul>

<h3 id="process-monitor">Process Monitor</h3>

<p>You can get basic information from Task Manager in Windows, but Process Monitor allows you to track every action of a given process. 
Be warned that Process Manager generates a lot of data, all of which it stores in RAM. So, it may quickly fill up the memory of a VM and crash it if 
left to run for a long time.</p>

<p>No one in their right mind uses Process Monitor without applying some filters. We will apply filters soon to the gigantic pile
of data pouring in.</p>

<div class="alert alert-danger"><strong>Final reminder!</strong> Make sure that you have a snapshot of your nice and un-ransomware'd vm before proceeding!</div>

<ol>
  <li>Launch Process Monitor. From within Process Monitor, launch the Process Tree (<code class="highlighter-rouge">Tools</code> &gt; <code class="highlighter-rouge">Process Tree</code>).</li>
  <li>With Process Monitor running, <em>run the <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code></em>. OH NO YOU ARE UNDER ATTACK. <em>Or are you?</em></li>
  <li>Stop Process Monitor from collecting (<code class="highlighter-rouge">File</code> &gt; <code class="highlighter-rouge">Capture Events</code> to toggle). Examine the Process Tree. Note the entry for <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code>.
Right-click it and <code class="highlighter-rouge">Add Process to Include Filter</code>. Back in the main process monitor view, we are now looking at only events associated with our malware worm.</li>
  <li>
    <p>In the icon menu on the top of Process Monitor, deselect all icons in the far-right section except for the third from the right – the one with two computers
and who-knows-what-shape on top of them. This will filter to show only network calls. This should at least one TCP Reconnect operation. This is the loader
calling out to the killswitch domain. If the call resolves successfuls, then the malware immediately exits without doing anything else (eyeroll @ DPRK).</p>

    <div class="alert alert-warning"><strong>Question: </strong>What was the value of the "Result" field for the calls to 104.17.41.137?</div>
  </li>
</ol>

<h3 id="disable-network-adapter-and-run-dropper-again">Disable Network Adapter and run dropper again</h3>

<p>The worm won’t killswitch if we don’t have an internet connection! Before we proceed, disable the VM’s network adapters. To do this, from the VM’s top-bar menu, select 
“Devices” &gt; “Network” &gt; click “Connect Network Adapter” to disconnect it. Verify that you do
<em>not</em> have internet access from within the VM before proceeding.</p>

<p>Open Process Monitor again. Do the following from the menu options:</p>

<ul>
  <li>Filter &gt; Reset Filter</li>
  <li>Edit &gt; Clear display</li>
  <li>File &gt; Capture Events (to enable capturing)</li>
</ul>

<ol>
  <li>
    <p>With Process Monitor running, right-click <code class="highlighter-rouge">24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c.exe</code> and choose “Run as Administrator.” OH NO YOU ARE UNDER ATTACK.
YES THIS TIME YOU REALLY ARE. TIME TO CRY.</p>
  </li>
  <li>
    <p>The dropper installed the file stored in its R resource section into the <code class="highlighter-rouge">C:\Windows\</code> directory, naming it <code class="highlighter-rouge">tasksche.exe</code>, and then ran it. This is the wannacry encryptor.</p>

    <div class="alert alert-warning"><strong>Question: </strong>What is the sha256 hash of <code>C:\Windows\tasksche.exe</code>?</div>
  </li>
  <li>
    <p>Well, what does this encryptor <em>do</em>? It scans through the entire drive for files with interesting file extensions, and it encrypts them, storing an encrypted version
of the decryption key in header info in the file itself. The encrypted variants of all of your precious files have a <code class="highlighter-rouge">.WNCRY</code> extension.</p>

    <p><code class="highlighter-rouge">strings</code> in <code class="highlighter-rouge">tasksche.exe</code> shows that it is looking for files with the following extensions:</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.der .pfx .key .crt .csr .p12 .pem .odt .ott .sxw .stw .uot .3ds .max .3dm .ods .ots .sxc .stc .dif .slk .wb2 .odp .otp .sxd 
.std .uop .odg .otg .sxm .mml .lay .lay6 .asc .sqlite3 .sqlitedb .sql .accdb .mdb .db .dbf .odb .frm .myd .myi .ibd .mdf .ldf 
.sln .suo .cs .cpp .pas .asm .js .cmd .bat .ps1 .vbs .vb .pl .dip .dch .sch .brd .jsp .php .asp .rb .java .jar .class .sh .mp3 
.wav .swf .fla .wmv .mpg .vob .mpeg .asf .avi .mov .mp4 .3gp .mkv .3g2 .flv .wma .mid .m3u .m4u .djvu .svg .ai .psd .nef .tiff 
.tif .cgm .raw .gif .png .bmp .jpg .jpeg .vcd .iso .backup .zip .rar .7z .gz .tgz .tar .bak .tbk .bz2 .PAQ .ARC .aes .gpg .vmx 
.vmdk .vdi .sldm .sldx .sti .sxi .602 .hwp .snt .onetoc2 .dwg .pdf .wk1 .wks .123 .rtf .csv .txt .vsdx .vsd .edb .eml .msg .ost 
.pst .potm .potx .ppam .ppsx .ppsm .pps .pot .pptm .pptx .ppt .xltm .xltx .xlc .xlm .xlt .xlw .xlsb .xlsm .xlsx .xls .dotx .dotm 
.dot .docm .docb .docx .doc
</code></pre></div>    </div>

    <p>It then pops up an annoying
notification about your ransomed state which will continue to pop up every sixty seconds or so. Best way to deal with that popup is to <em>not</em> “X” it out, but rather,
drag it to a corner of your screen, almost out of sight.</p>

    <p>Right-click one of the encrypted files on your desktop, and “Edit in Notepad++” to examine the contents. What used to be plaintext aint so plain anymore, ‘tis it?
The first 8 bytes of any file encrypted by wannacry are always the same. This is wannacry’s “magic number” You can see it in notepad++ or in a hex examiner such
as HxD (installed on the VM).</p>

    <div class="alert alert-warning"><strong>Question: </strong>What is the magic number for a wannacry-encrypted file?</div>
  </li>
</ol>

<h3 id="decrypting-the-wannacrypted-files">Decrypting the WannaCrypted files</h3>

<p>Just kidding. You can’t.</p>

<p>Actually, you can with two long-shots.</p>

<ol>
  <li>
    <p>A decryption tool exists which can extract the prime numbers from memory which were used in the encryption.
However, <a href="https://blog.malwarebytes.com/cybercrime/2017/05/wannadecrypt-your-files/">huge caveats</a>: it relies on a Windows encryption implementation bug that only only works for Windows OS versions less than 10, 
(e.g., XP through 7), and “it relies on current running memory so once you reboot it will be gone and if you’ve done too much on the system since infection, 
it’s possible the key won’t be found (because it’s been overwritten by data from other applications using the same memory space).”</p>
  </li>
  <li>
    <p>Also, there’s a chance that if you pay the ransom, you will get a response… <a href="https://www.pcworld.com/article/3196880/security/paying-the-wannacry-ransom-will-probably-get-you-nothing-heres-why.html">but</a>, “Those who do shouldn’t expect a quick response – or any response at all. Even after payment, the ransomware doesn’t 
automatically release your computer and decrypt your files, according to security researchers. Instead, victims have to wait and hope WannaCry’s developers will remotely free the hostage computer over the internet. 
It’s a process that’s entirely manual and contains a serious flaw: The hackers have no way to prove who paid off the ransom.” Sigh.</p>
  </li>
</ol>

<div class="alert alert-info"><strong>Best defense against ransomware?</strong> Backups! Do you have one?</div>

<h3 id="bonus-reading">Bonus Reading!</h3>

<p>In September 2018, the US Justice Department <a href="https://arstechnica.com/information-technology/2018/09/us-indicts-north-korean-agents-for-wannacry-sony-attacks/">indicted a North Korean agent who participated in the WannaCry and Sony hacks</a>.</p>

<div class="alert alert-warning"><strong>Question: </strong>What is the name of the indicted agent?</div>

<h1 id="references">References</h1>

<ul>
  <li><a href="https://www.fireeye.com/blog/threat-research/2017/05/wannacry-malware-profile.html">https://www.fireeye.com/blog/threat-research/2017/05/wannacry-malware-profile.html</a></li>
  <li><a href="https://www.malware-traffic-analysis.net/2017/05/18/index2.html">https://www.malware-traffic-analysis.net/2017/05/18/index2.html</a></li>
</ul>




<script type='text/javascript'>
    var $ul = $('<ul></ul>').addClass('nav nav-pills');
    $('h1:not(.title)').each(function() {
        var anchor_location = $(this).text().toLowerCase().replace(/ /g, '-').replace(/,/g, '');
        $a = $('<a></a>').attr('href', '#' + anchor_location).text($(this).text());
        $li = $('<li></li>');
        $li.append($a);
        $ul.append($li);
    });
    $('#nav-bar').append($ul);
    
</script>

</div><!-- content -->
<div class="row">
	
	<div class="col-sm-10 col-sm-offset-1 footer">
	
		<div class="fine-print">
			<a href="/feed.xml">
				<i class="fa fa-rss"></i>
			</a>
			<a href="/fine-print/">Fine Print</a>
		</div>
	</div>
</div>

</div><!--/.container-->


<script src="/assets/vendor/anchor-js/anchor.min.js"></script>
<script>anchors.add('h3, h4, h5, h6');</script>

<script src="/assets/vendor/bootstrap-sass/assets/javascripts/bootstrap.min.js"></script>


	<!-- Google Analytics -->
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-35065822-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/security-assignments/lab_malware/',
		  'title': 'Lab &ndash; Malware Analysis'
		});
	</script>
	<!-- End Google Analytics -->



</body>
</html>
<!-- Powered by GitHub | Generated 2018-12-01 13:41:09 -0500 | Revision 92502d237dc856d080ccef6ea6f23eeb27ec96ab -->